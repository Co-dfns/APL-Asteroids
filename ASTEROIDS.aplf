ASTEROIDS;frame_size;Conga;DRC;rc;srv;title;hr;_;LISTEN
	;CON;ERR;TICK;WSU
	;RENDER

⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ STATE GOES HERE ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝
frame_size←640 480

⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ STARTUP CODE ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝
'Conga'⎕CY'conga'
DRC←Conga.Init'ASTEROIDS'
{}DRC.SetProp '.' 'EventMode' 1
rc srv←DRC.Srv '' 'localhost' 4572 'http' ('Options' DRC.Options.(WSAutoUpgrade))

⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ HTML INTERFACE ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝
title←'Asteroids - Copyright (c) 2025 by Aaron W. Hsu'
hr←⎕NEW'HtmlRenderer'(⊂'Caption' title)
hr.(Coord Size)←'ScaledPixel' (540 680)
_←'<!DOCTYPE html>'
_,←'<style>'
_,←'	body{overflow:hidden;margin:0px;padding:10px;background:#202020;}'
_,←'	#d{border:1px solid green;display:block;padding:0px;margin:0px auto;}'
_,←'</style>'
_,←'<script>'
_,←'var a, d, c, s;'
_,←'function init() {'
_,←'	a = document.getElementById("au_laser");'
_,←'	d = document.getElementById("d");'
_,←'	c = d.getContext("2d");'
_,←'	s = new WebSocket("ws://localhost:4572/");'
_,←'	s.onmessage = (evt) => {render(...JSON.parse(evt.data));};'
_,←'	window.onkeydown = handle_keydown;'
_,←'	window.onkeyup = handle_keyup;'
_,←'}'
_,←'function handle_keydown(evt) {'
_,←'	s.send("KD_" + evt.key);'
_,←'}'
_,←'function handle_keyup(evt) {'
_,←'	s.send("KU_" + evt.key);'
_,←'}'
_,←'function render(msg, color, diff, score, fire, objs) {'
_,←'	for (let i = 0; i < objs.length; i++) {'
_,←'		objs[i][0] = document.getElementById(objs[i][0]);'
_,←'	}'
_,←'	var g = c.createLinearGradient(0,0,25,480);'
_,←'	g.addColorStop(1, "#000000");'
_,←'	g.addColorStop(0, diff);'
_,←'	c.clearRect(0, 0, d.width, d.height);'
_,←'	c.fillStyle = g;'
_,←'	c.fillRect(0, 0, 25, 480);'
_,←'	c.font = "50px Courier";'
_,←'	c.fillStyle = color;'
_,←'	for (let i = 0; i < objs.length; i++) {'
_,←'		const obj = objs[i];'
_,←'		c.drawImage(obj[0], obj[1], obj[2], obj[3], obj[4]);'
_,←'	}'
_,←'	c.fillText(msg, 75, 250);'
_,←'	c.font = "30px Courier";'
_,←'	c.fillStyle = "white";'
_,←'	c.fillText(score, 30, 30);'
_,←'	if (fire) a.play();'
_,←'}'
_,←'window.onload = init;'
_,←'</script>'
_,←'<display style="display:none;">'
_,←'	<!-- Credit MillionthVector https://millionthvector.blogspot.com/p/free-sprites.html -->'
_,←'	<img id="ship" src="https://github.com/Co-dfns/APL-Asteroids/blob/master/blueship2.png?raw=true">'
_,←'	<img id="alien" src="https://github.com/Co-dfns/APL-Asteroids/blob/master/aliensprite2.png?raw=true">'
_,←'	<!-- Credit GameProgrammingSlave https://opengameart.org/content/explosions -->'
_,←'	<img id="expl" src="https://github.com/Co-dfns/APL-Asteroids/blob/master/explosion0.png?raw=true">'
_,←'	<!-- Credit Wenrexa https://opengameart.org/content/assets-free-laser-bullets-pack-2020 -->'
_,←'	<img id="bolt" src="https://github.com/Co-dfns/APL-Asteroids/blob/master/laser.png?raw=true">'
_,←'	<audio id="au_laser" auto_play="false"><source src="https://opengameart.org/sites/default/files/laser1.mp3" type="audio/mpeg"></audio>'
_,←'</display>'
_,←'<canvas id="d" height="480" width="640">Loading...</canvas>'
hr.HTML←_


⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ STIMULI ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝
CON ERR TICK WSU←1+⍳4
LISTEN←{rc←⊃z←DRC.Wait srv 15
	0≠rc:				ERR	⍝ Error in server
	rc obj evt dat∘←z
	'Connect'≡evt:			CON	⍝ Connection from GUI
	
	⍝⍝⍝⍝⍝⍝ HANDLE REMAINING STIMULI HERE ⍝⍝⍝⍝⍝⍝⍝⍝
}

⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ RESPONSES ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝
RENDER←{

	⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ YOU NEED RENDER CODE ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝

	1:_←DRC.Send gui (data 1 1)
}

⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝ SEQUENCE ENUMERATION BEGINS ⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝⍝
∆_:→LISTEN ⎕LC

CLEANUP:
 ⎕EX'DRC'
 ⎕EX'Conga'
